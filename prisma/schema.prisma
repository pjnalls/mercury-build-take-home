// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Define Enums for clarity and data integrity
enum RuleEnum {
  ALL    // Every assignee must submit a POSITIVE response
  ANY    // Any single assignee submits a POSITIVE response
  K_OF_N // K positive responses are required
}

enum ResponseEnum {
  POSITIVE
  NEGATIVE
}

enum WorkflowStatusEnum {
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum HistoryEventEnum {
  WORKFLOW_STARTED
  STEP_ADVANCED
  STEP_SENT_BACK
  WORKFLOW_COMPLETED
}

// --- Tables ---

// Table to store user information
model User {
  id         Int      @id @default(autoincrement())
  name       String   
  email      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  templateStepAssignees   TemplateStepAssignee[]
  responses               Response[]
  workflowAssignees       WorkflowAssignee[]
}

// Main table to define Workflow Templates
model WorkflowTemplate {
  id         Int      @id @default(autoincrement())
  name       String   
  description String? 
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  // Relations
  versions WorkflowTemplateVersion[]
}

// **New Table:** workflow_template_versions
// To version the definition of the steps for a template.
model WorkflowTemplateVersion {
  id                 Int      @id @default(autoincrement())
  workflowTemplateId Int
  versionNumber     Int      @default(1)
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())

  // Relations
  workflowTemplate WorkflowTemplate @relation(fields: [workflowTemplateId], references: [id])
  templateSteps    TemplateStep[]
  workflows        Workflow[]

  @@unique([workflowTemplateId, versionNumber])
}

// Defines the Ordered Steps for a specific Workflow Template **Version**
model TemplateStep {
  id                          Int      @id @default(autoincrement())
  workflowTemplateVersionId   Int
  stepName                    String   
  stepOrder                   Int
  metadata                    Json?
  completionRuleType          RuleEnum
  kValue                      Int?
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @default(now()) @updatedAt

  // Relations
  workflowTemplateVersion   WorkflowTemplateVersion @relation(fields: [workflowTemplateVersionId], references: [id])
  templateStepAssignees     TemplateStepAssignee[]
  responses                 Response[]
  workflowAssignees         WorkflowAssignee[]
  history                   History[]

  @@unique([workflowTemplateVersionId, stepOrder])
}

// Defines the allowed Assignee Roles/Groups for a Step in a Template **Version**
model TemplateStepAssignee {
  templateStepId Int
  userId          Int
  createdAt       DateTime @default(now())

  // Relations
  templateStep  TemplateStep @relation(fields: [templateStepId], references: [id])
  user          User         @relation(fields: [userId], references: [id])

  @@id([templateStepId, userId])
}

// Instances of workflows being executed
model Workflow {
  id                          Int      @id @default(autoincrement())
  workflowTemplateVersionId   Int
  currentStepOrder            Int      @default(1)
  status                      WorkflowStatusEnum
  startedAt                   DateTime @default(now())
  completedAt                 DateTime?
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @default(now()) @updatedAt

  // Relations
  workflowTemplateVersion   WorkflowTemplateVersion @relation(fields: [workflowTemplateVersionId], references: [id])
  responses                 Response[]
  workflowAssignees         WorkflowAssignee[]
  history                   History[]
}

// Table for responses to workflow steps
model Response {
  id               Int      @id @default(autoincrement())
  workflowId       Int
  templateStepId   Int
  revisionNumber   Int      @default(1) // **NEW COLUMN**
  responderId      Int
  responseType     ResponseEnum
  description      String?  
  createdAt       DateTime @default(now())

  // Relations
  workflow    Workflow   @relation(fields: [workflowId], references: [id])
  templateStep TemplateStep @relation(fields: [templateStepId], references: [id])
  responder   User       @relation(fields: [responderId], references: [id])
  history     History[]
  attachments ResponseAttachment[]

  @@unique([workflowId, templateStepId, revisionNumber])
}

// Tracks the Specific Assignees for an Active Workflow Instance and its Current Step
model WorkflowAssignee {
  workflowId      Int
  templateStepId Int
  assigneeUserId Int
  createdAt       DateTime @default(now())

  // Relations
  workflow      Workflow   @relation(fields: [workflowId], references: [id])
  templateStep TemplateStep @relation(fields: [templateStepId], references: [id])
  assignee      User       @relation(fields: [assigneeUserId], references: [id])

  @@id([workflowId, templateStepId, assigneeUserId])
  @@index([workflowId, templateStepId]) // Index for common lookups
}

// Table to log history of state changes
model History {
  id                      Int      @id @default(autoincrement())
  workflowId              Int
  templateStepId          Int
  nextStepOrder           Int?
  eventType               HistoryEventEnum
  triggeredByResponseId   Int?
  createdAt              DateTime @default(now())

  // Relations
  workflow    Workflow   @relation(fields: [workflowId], references: [id])
  templateStep TemplateStep @relation(fields: [templateStepId], references: [id])
  triggeredByResponse Response? @relation(fields: [triggeredByResponseId], references: [id])
}

// Separate table for file attachments to responses
model ResponseAttachment {
  id         Int      @id @default(autoincrement())
  responseId Int
  fileUrl    String   
  fileName   String?  
  createdAt  DateTime @default(now())

  // Relations
  response Response @relation(fields: [responseId], references: [id])
}